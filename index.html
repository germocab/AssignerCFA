<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignador de Turnos para la Predicación</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png">
<link rel="manifest" href="favicon_io/site.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
    
    <style>
        :root {
            --primary: #0071bc;
            --primary-hover: #005a96;
            --bg: #f8f9fa;
            --text-main: #1d1d1f;
            --text-sub: #86868b;
            --white: #ffffff;
            --border: #d2d2d7;
        }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: var(--bg); 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; margin: 0; 
        }

        .container { 
            width: 95%; max-width: 550px; background: var(--white); 
            padding: 30px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.05); 
        }

        /* Barra de Progreso */
        .progress-container { background: #e5e5e7; height: 6px; border-radius: 10px; margin-bottom: 25px; }
        .progress-bar { background: var(--primary); height: 100%; width: 20%; border-radius: 10px; transition: 0.4s ease; }

        .step { display: none; animation: slideIn 0.3s ease-out; }
        .step.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }

        label { display: block; text-align: center; font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--text-main); }

        /* --- CUADRÍCULA DE PERSONAS 2x2 --- */
        .people-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
            max-height: 320px; overflow-y: auto; padding: 5px;
        }

        .person-card {
            display: flex; align-items: center; background: var(--white);
            border: 2px solid transparent; border-radius: 50px;
            padding: 5px 12px 5px 5px; cursor: pointer; transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03); width: 100%; box-sizing: border-box;
        }

        .person-card:hover { border-color: var(--primary); }
        .person-card.selected { background: var(--primary); border-color: var(--primary); }
        .person-card.selected .p-name, .person-card.selected .p-role { color: var(--white); }

        .avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; margin-right: 10px; background: #eee; }
        .p-info { display: flex; flex-direction: column; overflow: hidden; text-align: left; }
        .p-name { font-weight: 700; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-role { font-size: 0.7rem; color: var(--text-sub); }

        /* --- CALENDARIO DE RANGO --- */
        .range-container {
            text-align: center;
            background: #f2f2f7;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }
        #range-display {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
            margin-top: 10px;
            display: block;
        }

        /* Botones y Otros */
        .nav-btns { display: flex; gap: 15px; margin-top: 25px; }
        .nav-btns button { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; }
        .btn-prev { background: #e5e5e7; color: var(--text-main); }
        .btn-next { background: var(--primary); color: white; }

        .opt-btn { width: 100%; padding: 14px; margin-bottom: 8px; border-radius: 12px; border: 1px solid var(--border); background: white; cursor: pointer; }
        .opt-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

        .search-box input, input[type="time"], #date-range-input { 
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 10px; box-sizing: border-box; font-size: 1rem;
        }

/* Estilo para los contenedores de hora 2x2 */
    .time-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 10px;
    }

    .time-box {
        background: #f2f2f7;
        padding: 15px;
        border-radius: 18px;
        border: 1px solid var(--border);
        text-align: center;
        cursor: pointer;
        transition: 0.2s;
    }

    .time-box:hover {
        border-color: var(--primary);
        background: #fff;
    }

    .time-box label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--text-sub);
        margin-bottom: 5px;
        display: block;
        letter-spacing: 1px;
    }

    .time-val {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--text-main);
        display: block;
    }

    /* Ocultar los inputs reales pero mantenerlos para la lógica */
    .hidden-input {
        position: absolute;
        visibility: hidden;
        height: 0;
    }
        
    </style>
</head>
<body>

<div class="container">
    <div class="progress-container"><div class="progress-bar" id="progress"></div></div>
    
    <div class="step active">
        <label>Día de la Semana</label>
        <button class="opt-btn" onclick="selectItem('day', 'Lunes', this)">Lunes</button>
        <button class="opt-btn" onclick="selectItem('day', 'Martes', this)">Martes</button>
        <button class="opt-btn" onclick="selectItem('day', 'Miércoles', this)">Miércoles</button>
        <button class="opt-btn" onclick="selectItem('day', 'Jueves', this)">Jueves</button>
        <button class="opt-btn" onclick="selectItem('day', 'Viernes', this)">Viernes</button>
        <button class="opt-btn" onclick="selectItem('day', 'Sábado', this)">Sábado</button>
        <button class="opt-btn" onclick="selectItem('day', 'Domingo', this)">Domingo</button>
    </div>

    <div class="step">
        <label>Participantes (Máx. 3)</label>
        <div class="search-box"><input type="text" id="p-search" placeholder="Buscar..." onkeyup="filterPeople()"></div>
        <div id="p-counter" style="text-align: center; font-size: 0.85rem; color: var(--primary); font-weight: bold; margin-bottom: 10px;">Seleccionados: 0/3</div>
        <div class="people-grid" id="people-list"></div>
    </div>

    <div class="step">
        <label>Punto de Predicación</label>
        <div style="max-height: 250px; overflow-y: auto;">
            <button class="opt-btn" onclick="selectItem('station', 'Supermercado Líder', this)">Líder</button>
            <button class="opt-btn" onclick="selectItem('station', 'Clínica Cordillera', this)">Clínica Cordillera</button>
            <button class="opt-btn" onclick="selectItem('station', 'Santa Zita', this)">Santa Zita</button>
            <button class="opt-btn" onclick="selectItem('station', 'Visviri', this)">Visviri / Santa Isabel</button>
            <button class="opt-btn" onclick="selectItem('station', 'Feria Bilbao', this)">Feria Bilbao</button>
            <button class="opt-btn" onclick="selectItem('station', 'Parque Intercomunal', this)">Parque Intercomunal</button>
            <button class="opt-btn" onclick="selectItem('station', 'Patricia', this)">Patricia</button>
        </div>
    </div>

    <div class="step">
        <label>Selecciona el Periodo</label>
        <div class="range-container">
            <input type="text" id="date-range-input" placeholder="Toca para abrir calendario...">
            <span id="range-display">Ninguna fecha seleccionada</span>
        </div>
        <p style="font-size: 0.8rem; color: var(--text-sub); text-align: center; margin-top: 10px;">
            Selecciona el primer día y luego el último día del turno.
        </p>
    </div>

    <div class="step">
    <label>Horario del Turno</label>
    <div class="time-grid">
        <div class="time-box" onclick="document.getElementById('time-start')._flatpickr.open()">
            <label>Inicio</label>
            <span class="time-val" id="display-start">09:00</span>
            <input type="text" id="time-start" class="hidden-input">
        </div>
        <div class="time-box" onclick="document.getElementById('time-end')._flatpickr.open()">
            <label>Fin</label>
            <span class="time-val" id="display-end">11:00</span>
            <input type="text" id="time-end" class="hidden-input">
        </div>
    </div>
    <p style="font-size: 0.8rem; color: var(--text-sub); text-align: center; margin-top: 15px;">
        Toca cada recuadro para ajustar la hora.
    </p>
</div>
    
    <div class="nav-btns">
        <button class="btn-prev" id="prevBtn" onclick="move(-1)" style="display:none">Atrás</button>
        <button class="btn-next" id="nextBtn" onclick="move(1)">Siguiente</button>
    </div>
    <div id="status" style="text-align: center; margin-top: 15px; font-weight: bold;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

<script>

// Añade esto a tu función window.onload o donde inicializas los scripts
 // 1. Inicialización unificada de Flatpickr para horas
function initTimePickers() {
    const config = {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        disableMobile: "true", // Esto asegura que use el estilo de Flatpickr y no el nativo del móvil
        onClose: function(selectedDates, dateStr, instance) {
            const displayId = instance.element.id === 'time-start' ? 'display-start' : 'display-end';
            document.getElementById(displayId).innerText = dateStr;
        }
    };

    // Inicializar y asignar valores por defecto a los inputs ocultos
    flatpickr("#time-start", { ...config, defaultDate: "09:00" });
    flatpickr("#time-end", { ...config, defaultDate: "11:00" });
    
    // Asegurar que los inputs tengan valor inicial para el envío de datos
    document.getElementById('time-start').value = "09:00";
    document.getElementById('time-end').value = "11:00";
}

// ... (aquí mantén tus variables SCRIPT_URL, gente, etc.)

// 2. FUNCIÓN ONLOAD ÚNICA
window.onload = () => {
    renderPeople();      // Carga la lista de personas
    initPicker();        // Carga el calendario de rango
    initTimePickers();   // Carga los selectores de hora
};

// ... (aquí el resto de tus funciones como move, togglePerson, etc.)
    
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbykFawTvnXDqzBgEjhBT1Kq0chGh1AyfsMw7J7QW_EMKWC5c8Ebnm3kj2P78DxfJ-t0Jg/exec';
    
    let gente = ["Germán Cabezas", "Natalia de Palomino", "Manuel Tobar", "Claudia de Tobar", "Fernando Aldunate", "Nataly de Aldunate", "Ana María de Muñoz", "Nicolás Muñoz", "Juanita Gajardo", "Rosita Minda", "Nelly Ticse", "Constanza Donoso", "María Luísa de Reyes", "Marta de García", "Douglas García", "Ingrid Arnold", "Antonio Silva", "Mariolly de Silva", "Daniela de Brito", "Zoltan Jeu", "Paula de Jeu", "Claudia Carrión", "Thaís Contreras", "Carlos Moya", "Tomás Vergara", "Gisella de Vergara", "Fedora Tironi", "Francisca de López"];

    let currentStep = 0;
    let selections = { day: null, people: [], station: null, dateRange: "" };

    // Configuración del Calendario de Rango
    let picker;
    function initPicker() {
        picker = flatpickr("#date-range-input", {
            mode: "range",
            dateFormat: "d-m-Y",
            locale: "es",
            onChange: function(selectedDates) {
                if (selectedDates.length === 2) {
                    const start = selectedDates[0].toLocaleDateString('es-ES');
                    const end = selectedDates[1].toLocaleDateString('es-ES');
                    selections.dateRange = `${start} al ${end}`;
                    document.getElementById('range-display').innerText = selections.dateRange;
                }
            }
        });
    }

    function renderPeople() {
        const container = document.getElementById('people-list');
        container.innerHTML = '';
        gente.forEach(nombre => {
            const card = document.createElement('button');
            card.className = 'person-card';
            card.innerHTML = `<img src="img/${nombre}.jpg" class="avatar" onerror="this.src='https://ui-avatars.com/api/?name=${nombre}&background=random'"><div class="p-info"><span class="p-name">${nombre}</span><span class="p-role">Precursor/a</span></div>`;
            card.onclick = () => togglePerson(nombre, card);
            container.appendChild(card);
        });
    }

    function filterPeople() {
        const term = document.getElementById('p-search').value.toLowerCase();
        document.querySelectorAll('.person-card').forEach(card => {
            card.style.display = card.querySelector('.p-name').innerText.toLowerCase().includes(term) ? 'flex' : 'none';
        });
    }

    function togglePerson(name, el) {
        const idx = selections.people.indexOf(name);
        if (idx > -1) { selections.people.splice(idx, 1); el.classList.remove('selected'); }
        else if (selections.people.length < 3) { selections.people.push(name); el.classList.add('selected'); }
        document.getElementById('p-counter').innerText = `Seleccionados: ${selections.people.length}/3`;
    }

    function selectItem(cat, val, el) {
        selections[cat] = val;
        el.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
    }

    function move(n) {
        const steps = document.querySelectorAll('.step');
        if (n === 1 && currentStep === steps.length - 1) { sendData(); return; }
        steps[currentStep].classList.remove('active');
        currentStep += n;
        steps[currentStep].classList.add('active');
        document.getElementById('prevBtn').style.display = currentStep === 0 ? 'none' : 'block';
        document.getElementById('nextBtn').innerText = currentStep === steps.length - 1 ? 'Registrar' : 'Siguiente';
        document.getElementById('progress').style.width = ((currentStep + 1) / steps.length * 100) + '%';
    }

    function sendData() {
        const status = document.getElementById('status');
        const tStart = document.getElementById('time-start').value;
        if (!selections.day || !selections.station || !selections.dateRange || !tStart) {
            alert("Faltan datos"); return;
        }
        status.innerText = "Registrando...";
        document.getElementById('nextBtn').disabled = true;
        let tipo = selections.people.length === 0 ? "TD" : (parseInt(tStart) < 12 ? "M" : "T");
        const payload = {
            dia: selections.day, tipo: tipo,
            participantes: selections.people.join(", ") || "DISPONIBLE",
            horario: `${tStart} - ${document.getElementById('time-end').value}`,
            punto: selections.station, periodo: selections.dateRange
        };
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain;charset=utf-8' }})
        .then(() => { status.innerText = "¡Éxito!"; setTimeout(() => location.reload(), 2000); });
    }

    window.onload = () => { renderPeople(); initPicker(); };
</script>
</body>
</html>



